# 통찰방 커뮤니티 - 기능 상세 가이드

이 문서는 통찰방 커뮤니티 플랫폼의 모든 기능을 상세히 설명합니다.

## 목차
1. [투표 시스템](#1-투표-시스템)
2. [오프라인 모임 시스템](#2-오프라인-모임-시스템)
3. [인증 시스템](#3-인증-시스템)
4. [알림 시스템](#4-알림-시스템)
5. [관리자 기능](#5-관리자-기능)

---

## 1. 투표 시스템

### 1.1 투표 기간 생성 (관리자)

**위치**: `/admin/votes`

**기능**:
- 관리자가 커스텀 제목과 설명으로 투표 기간 생성
- 시작일과 종료일 지정
- 예시: "통찰방 10월-1 베스트 글 투표"

**사용 방법**:
1. 관리자 대시보드 → 투표 관리
2. "새 투표 기간 만들기" 버튼 클릭
3. 제목, 설명, 시작일, 종료일 입력
4. "투표 기간 생성" 버튼 클릭

**구현 코드**: `src/pages/admin/AdminVotesPage.jsx:56-102`

### 1.2 글 제출

**위치**: `/vote`

**기능**:
- 사용자가 투표 기간 동안 글 제출
- 제목, 작성자 이름, 본문 입력
- 작성자 이름: 원작자 또는 본인 이름

**사용 방법**:
1. 투표 페이지 접속
2. "글 제출하기" 버튼 클릭
3. 제목, 작성자, 본문 입력
4. "제출" 버튼 클릭

**주의사항**:
- 복사한 글인 경우 원작자 이름 입력
- 본인이 쓴 글인 경우 본인 이름 입력
- 작성자 필드는 필수 입력

**구현 코드**: `src/pages/voting/VotePage.jsx:217-232`

### 1.3 추천 투표 (1인 1표, 토글 방식)

**위치**: `/vote`

**기능**:
- 제출된 글에 추천 투표
- 1인당 1개 글에만 투표 가능
- 다시 클릭하면 투표 취소
- 실시간 추천수 표시

**사용 방법**:
1. 투표 페이지에서 글 목록 확인
2. "👍 추천" 버튼 클릭 (투표)
3. 다시 클릭하면 투표 취소
4. 버튼 색상: 초록색 = 투표함, 회색 = 투표 안 함

**구현 코드**: `src/pages/voting/VotePage.jsx:105-154`

### 1.4 우승자 자동 선정

**위치**: `/admin/votes`

**기능**:
- 투표 종료 시 최다 득표자 자동 선정
- 동점자 처리: 쉼표로 구분하여 모두 표시
- 예시: "홍길동, 김철수, 이영희"

**사용 방법**:
1. 관리자 대시보드 → 투표 관리
2. 모집 중인 투표 기간 찾기
3. "종료" 버튼 클릭
4. 우승자 자동 선정 및 표시

**구현 코드**: `src/pages/admin/AdminVotesPage.jsx:143-228`

### 1.5 관리자 글 목록 조회

**위치**: `/admin/votes`

**기능**:
- 투표 기간별 제출된 글 조회
- 추천수 순으로 정렬
- 순위, 제목, 작성자, 추천수 표시

**사용 방법**:
1. 관리자 대시보드 → 투표 관리
2. 투표 기간 목록에서 "글 보기" 버튼 클릭
3. 모달에서 추천수 순 글 목록 확인

**구현 코드**: `src/pages/admin/AdminVotesPage.jsx:230-317`

---

## 2. 오프라인 모임 시스템

### 2.1 모임 생성

**위치**: `/meetings/create`

**기능**:
- 누구나 모임 생성 가능
- 커피 또는 술 모임 선택
- 장소, 날짜/시간, 최대 인원 설정

**사용 방법**:
1. 오프라인 모임 페이지
2. "새 모임 만들기" 버튼
3. 정보 입력 후 생성

**구현 코드**: `src/pages/meetings/CreateMeetingPage.jsx`

### 2.2 모임 참가

**위치**: `/meetings/:id`

**기능**:
- 모임 상세 페이지에서 참가 신청
- 자동으로 익명 이름 부여 ("참가자1", "참가자2", ...)
- 참가 즉시 익명 채팅방 입장

**사용 방법**:
1. 모임 목록에서 원하는 모임 클릭
2. "모임 참가하기" 버튼 클릭
3. 자동으로 익명 채팅방 입장

**구현 코드**: `src/pages/meetings/MeetingDetailPage.jsx:143-160`

### 2.3 익명 채팅

**위치**: `/meetings/:id` (참가자만)

**기능**:
- 실시간 익명 채팅 (Supabase Realtime)
- 자동 익명 이름 부여
- 주최자는 왕관 이모지(👑)로 구분
- 자동 스크롤 (새 메시지 도착 시)

**사용 방법**:
1. 모임에 참가
2. 채팅 입력창에 메시지 입력
3. "전송" 버튼 클릭
4. 실시간으로 다른 참가자들과 대화

**주최자 구분**:
- 주최자 메시지: 노란 배경 + 왕관 이모지
- 일반 참가자: 흰 배경
- 본인 메시지: 파란 배경

**구현 코드**: `src/pages/meetings/MeetingDetailPage.jsx:348-404`

### 2.4 실시간 채팅 알림

**기능**:
- 다른 참가자가 메시지 보낼 때 웹 알림
- 알림 벨 아이콘에 미읽음 개수 표시
- 본인 메시지는 알림 없음

**구현 코드**: `src/pages/meetings/MeetingDetailPage.jsx:99-141`

### 2.5 관리자 모임 삭제

**위치**: `/meetings/:id` (관리자만)

**기능**:
- 관리자가 문제 있는 모임 삭제
- 채팅, 참가자, 모임 모두 삭제
- 되돌릴 수 없음 (주의)

**사용 방법**:
1. 관리자 계정으로 로그인
2. 모임 상세 페이지 이동
3. 하단의 "🗑️ 관리자: 모임 삭제" 버튼 클릭
4. 확인 대화상자에서 "확인" 클릭

**구현 코드**: `src/pages/meetings/MeetingDetailPage.jsx:162-215`

---

## 3. 인증 시스템

### 3.1 초대 코드 기반 회원가입

**위치**: `/signup`

**기능**:
- 6자리 숫자 초대 코드로 회원가입
- 카카오톡 닉네임으로 중복 가입 방지
- 비밀번호 서버 사이드 bcrypt 해싱

**사용 방법**:
1. 회원가입 페이지 접속
2. 초대 코드 입력 (6자리 숫자)
3. 카카오톡 닉네임, 비밀번호 입력
4. "회원가입" 버튼 클릭

**구현 코드**: `src/pages/auth/SignupPage.jsx`

### 3.2 로그인

**위치**: `/login`

**기능**:
- 카카오톡 닉네임과 비밀번호로 로그인
- 7일간 세션 유지
- localStorage 기반 세션 관리

**사용 방법**:
1. 로그인 페이지 접속
2. 카카오톡 닉네임, 비밀번호 입력
3. "로그인" 버튼 클릭

**구현 코드**: `src/pages/auth/LoginPage.jsx`

### 3.3 커스텀 인증 시스템

**기술 상세**:
- Supabase Auth 대신 커스텀 인증
- PostgreSQL 함수로 회원가입/로그인 처리
- `register_user()`: 비밀번호 해싱 후 사용자 생성
- `login_user()`: 비밀번호 검증 후 사용자 정보 반환
- bcrypt 해싱 (pgcrypto 확장)

**구현 코드**: `setup_auth_functions.sql`

---

## 4. 알림 시스템

### 4.1 웹 기반 알림

**위치**: 상단 네비게이션 바 (알림 벨 아이콘)

**기능**:
- 브라우저 알림 대신 웹 기반 알림
- 미읽음 개수 표시 (빨간 배지)
- 알림 클릭 시 해당 페이지로 이동
- localStorage 기반 알림 지속성

**알림 유형**:
- **채팅 알림**: 다른 사용자가 메시지 보냄
  - 표시: "새 채팅 메시지"
  - 내용: "참가자X: 메시지 내용"
  - 클릭 시 해당 모임 페이지로 이동

**사용 방법**:
1. 상단 알림 벨 아이콘 확인
2. 미읽음 알림이 있으면 빨간 배지 표시
3. 아이콘 클릭하여 알림 목록 확인
4. 알림 클릭 시 해당 페이지로 이동

**구현 코드**:
- Store: `src/store/notificationStore.js`
- 컴포넌트: `src/components/common/NotificationBell.jsx`

### 4.2 알림 관리

**기능**:
- 개별 알림 삭제
- 모든 알림 읽음 처리
- 모든 알림 삭제
- 읽음/미읽음 구분 표시

**사용 방법**:
1. 알림 벨 클릭하여 드롭다운 열기
2. "모두 읽음 처리" 버튼으로 모든 알림 읽음 처리
3. "모두 삭제" 버튼으로 모든 알림 삭제
4. 개별 알림의 "X" 버튼으로 개별 삭제

**구현 코드**: `src/store/notificationStore.js`

---

## 5. 관리자 기능

### 5.1 회원 관리

**위치**: `/admin/users`

**기능**:
- 전체 회원 목록 조회
- 회원 활성화/비활성화
- 회원 정보 확인 (닉네임, 가입일, 상태)

**사용 방법**:
1. 관리자 대시보드 → 회원 관리
2. 회원 목록 확인
3. 활성화/비활성화 버튼으로 상태 변경

**구현 코드**: `src/pages/admin/AdminUsersPage.jsx`

### 5.2 초대 코드 관리

**위치**: `/admin/invites`

**기능**:
- 6자리 숫자 초대 코드 생성
- 유효 기간: 7일
- 코드 무효화 (만료일을 과거로 변경)
- 코드 삭제 (사용되지 않은 코드만)

**사용 방법**:

#### 코드 생성
1. 관리자 대시보드 → 초대 코드 관리
2. 생성 개수 입력 (1-100)
3. "생성하기" 버튼 클릭
4. 생성된 코드를 사용자에게 전달

#### 코드 무효화
1. 초대 코드 목록에서 "무효화" 버튼 클릭
2. 확인 대화상자에서 "확인" 클릭
3. 코드가 즉시 만료됨 (사용 불가)

#### 코드 삭제
1. 사용되지 않은 코드에서 "삭제" 버튼 클릭
2. 확인 대화상자에서 "확인" 클릭
3. 코드가 완전히 삭제됨 (되돌릴 수 없음)

**주의사항**:
- 사용된 코드는 삭제할 수 없음 (무효화만 가능)
- 무효화는 되돌릴 수 없음
- 삭제는 완전히 제거되어 복구 불가

**구현 코드**: `src/pages/admin/AdminInvitesPage.jsx`

### 5.3 투표 관리

**위치**: `/admin/votes`

**기능**:
- 투표 기간 생성 (제목/설명 커스터마이징)
- 투표 기간 종료 (우승자 자동 선정)
- 제출된 글 추천수 순 조회
- 우승자 표시 (동점 처리)

**사용 방법**:
1. 관리자 대시보드 → 투표 관리
2. 투표 기간 목록 확인
3. "새 투표 기간 만들기" 또는 "종료" 버튼 사용
4. "글 보기" 버튼으로 제출된 글 확인

**구현 코드**: `src/pages/admin/AdminVotesPage.jsx`

### 5.4 커뮤니티 통계

**위치**: `/admin` (대시보드)

**기능**:
- 전체 회원 수
- 활성 회원 수
- 진행 중인 투표 수
- 예정된 모임 수

**구현 코드**: `src/pages/admin/AdminPage.jsx`

---

## 기술 구현 상세

### 1. RLS (Row Level Security) 정책

모든 테이블에 RLS 적용:
- 커스텀 인증 시스템 사용으로 인해 permissive 정책 사용
- `FOR ALL USING (true) WITH CHECK (true)`
- 서버 사이드에서 권한 검증

### 2. Realtime 구독

채팅에 Supabase Realtime 사용:
```javascript
const channel = supabase
  .channel(`meeting-${id}`)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'meeting_chats',
    filter: `meeting_id=eq.${id}`,
  }, (payload) => {
    // 새 메시지 처리
    setChats((prev) => [...prev, payload.new])
  })
  .subscribe()
```

### 3. 상태 관리 (Zustand)

전역 상태 관리:
- `authStore`: 사용자 인증 상태
- `notificationStore`: 알림 상태

### 4. 커스텀 인증

PostgreSQL 함수로 인증 처리:
```sql
CREATE OR REPLACE FUNCTION register_user(
  p_username TEXT,
  p_password TEXT,
  p_kakao_nickname TEXT,
  p_invite_code TEXT
) RETURNS JSON
SECURITY DEFINER
SET search_path = public
LANGUAGE plpgsql AS $$
-- 비밀번호 해싱 및 사용자 생성
$$;
```

---

## 문제 해결

### 채팅이 보이지 않는 경우
1. 모임에 참가했는지 확인
2. 브라우저 새로고침
3. 콘솔에서 Realtime 구독 상태 확인

### 투표가 안 되는 경우
1. 투표 기간이 진행 중인지 확인
2. 이미 다른 글에 투표했는지 확인
3. 브라우저 새로고침

### 알림이 오지 않는 경우
1. localStorage가 활성화되어 있는지 확인
2. 브라우저 콘솔에서 에러 확인
3. 알림 벨 아이콘 클릭하여 수동 확인

### 초대 코드 삭제가 안 되는 경우
1. 사용된 코드인지 확인 (사용된 코드는 무효화만 가능)
2. RLS 정책 확인 (`fix_invitation_codes_rls.sql` 실행)
3. 콘솔에서 에러 메시지 확인

---

## 추가 개선 가능 사항

1. **모임 수정 기능** (호스트 전용)
2. **참가자 강제 퇴장** (관리자/호스트)
3. **메시지 삭제** (본인 메시지만)
4. **읽음 표시** (누가 메시지를 읽었는지)
5. **타이핑 표시** (누가 입력 중인지)
6. **이미지/파일 전송**
7. **이모지 반응**
8. **메시지 검색**
9. **모바일 반응형**
10. **PWA 지원**

---

**최종 업데이트**: 2024년 10월 16일
