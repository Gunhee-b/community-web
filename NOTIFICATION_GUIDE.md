# 웹 페이지 알림 시스템

브라우저 알림 대신 웹 페이지 내부에 알림 센터를 구현했습니다!

## 🔔 기능 설명

### 알림 벨 (Notification Bell)
- 모든 페이지 상단 오른쪽에 종 모양 아이콘
- 읽지 않은 알림 개수를 빨간 배지로 표시
- 클릭하면 알림 드롭다운 메뉴가 나타남

### 알림 종류
1. **💬 채팅 메시지** - 다른 사용자가 모임 채팅방에 메시지를 보냄
2. **📅 모임 관련** - 향후 추가 가능
3. **🔔 시스템 알림** - 향후 추가 가능

## 📍 위치

알림 벨은 다음 위치에 표시됩니다:
- **MainLayout**: 일반 사용자 페이지 상단
- **AdminLayout**: 관리자 페이지 상단

```
┌─────────────────────────────────────────┐
│ 통찰방  홈  베스트글투표  모임  🔔³ 홍길동님 │
└─────────────────────────────────────────┘
              알림 벨 위치 ↑ (읽지 않은 알림 3개)
```

## 🎯 알림 생성 조건

### 채팅 메시지 알림
다음 조건을 **모두** 만족할 때 알림이 생성됩니다:

1. ✅ 다른 사용자가 메시지를 보냄 (본인 제외)
2. ✅ 같은 모임에 참가 중
3. ✅ Realtime 구독이 활성화됨

**예시:**
- 사용자 A가 모임 채팅에 메시지 전송
- 같은 모임에 참가한 사용자 B, C, D에게 알림 전송
- 사용자 A 본인에게는 알림이 가지 않음

## 💡 알림 기능

### 1. 알림 목록 보기
- 종 아이콘 클릭
- 최신 알림이 위에 표시
- **읽지 않은 알림만 표시됨** (읽은 알림은 자동으로 숨김)

### 2. 알림 읽기
- 알림을 클릭하면 해당 페이지로 이동
- 자동으로 **완전히 삭제**되어 목록에서 사라짐
- 채팅 알림 클릭 → 해당 모임 페이지로 이동

### 3. 개별 알림 삭제
- 각 알림 오른쪽의 X 버튼
- 개별 알림 완전 삭제

### 4. 전체 삭제
- 드롭다운 상단의 "전체 삭제" 버튼
- 확인 대화상자 후 모든 알림 완전 삭제

## 🗂️ 알림 저장

알림은 브라우저의 **localStorage**에 저장됩니다:
- 페이지를 새로고침해도 유지됨
- 로그아웃해도 유지됨
- 브라우저 캐시 삭제 시 삭제됨

## 📱 알림 UI

### 알림 벨 아이콘
```
🔔       → 알림 없음
🔔³      → 읽지 않은 알림 3개
🔔99+    → 읽지 않은 알림 99개 이상
```

### 알림 드롭다운
```
┌──────────────────────────────────────┐
│ 알림                       전체삭제   │
├──────────────────────────────────────┤
│ 💬 새 채팅 메시지                 X  │
│    참가자2: 안녕하세요!               │
│    3분 전                             │
├──────────────────────────────────────┤
│ 💬 새 채팅 메시지                 X  │
│    참가자1: 반갑습니다                │
│    10분 전                            │
└──────────────────────────────────────┘
```

### 읽지 않은 알림
- 파란색 배경 (`bg-blue-50`)
- 눈에 잘 띄게 표시
- 목록에 표시됨

### 읽은 알림
- **클릭 시 완전히 삭제됨** (localStorage에서도 제거)
- 읽은 알림은 더 이상 저장되지 않음
- 중복 알림 방지는 읽지 않은 알림만 체크

## 🛠️ 기술 구현

### 1. Zustand Store
```javascript
// src/store/notificationStore.js
- notifications: 알림 목록 배열
- unreadCount: 읽지 않은 알림 개수
- addNotification(notification): 새 알림 추가
  * messageId 기반 중복 체크 (읽지 않은 알림만 체크)
  * 이미 읽지 않은 알림이 존재하면 생성하지 않음
  * 읽은 알림은 삭제되므로 같은 메시지도 새로운 알림 생성 가능
- markAsRead(notificationId): 알림 읽음 처리 (사용 안 함)
  * read: true로 변경하여 목록에서 숨김
  * 현재는 사용하지 않음 (deleteNotification 사용)
- markAllAsRead(): 모든 알림 읽음 처리
- deleteNotification(notificationId): 개별 알림 완전 삭제
  * 알림 클릭 시 자동으로 호출됨
- clearAllNotifications(): 전체 삭제
```

### 2. NotificationBell 컴포넌트
```javascript
// src/components/common/NotificationBell.jsx
- 종 아이콘과 배지 (읽지 않은 알림 개수 표시)
- 드롭다운 메뉴
- unreadNotifications: 읽지 않은 알림만 필터링하여 표시
- 클릭 외부 감지로 자동 닫기
- 알림 클릭 시 페이지 이동 + 자동 삭제 (완전히 제거)
```

### 3. 알림 생성
```javascript
// MeetingDetailPage에서
addNotification({
  type: 'chat',
  title: '새 채팅 메시지',
  message: `${anonymousName}: ${message}`,
  meetingId: id,
  messageId: message.id, // 중복 방지를 위한 고유 메시지 ID
})
```

**중요:** `messageId`를 반드시 포함해야 중복 알림이 생성되지 않습니다.

## 🧪 테스트 방법

### 1. 브라우저 2개 열기
- 창 A: 사용자 1로 로그인
- 창 B: 사용자 2로 로그인

### 2. 같은 모임 참가
- 두 계정 모두 같은 모임에 참가

### 3. 메시지 전송
- 창 A에서 채팅 메시지 전송
- 창 B의 알림 벨 확인 (숫자 증가)

### 4. 알림 확인
- 창 B에서 종 아이콘 클릭
- 새 메시지 알림 확인
- 알림 클릭하면 해당 모임으로 이동

### 5. 알림 읽기 및 삭제 테스트
- 알림 클릭 → 해당 페이지 이동 + 목록에서 사라짐
- 배지 숫자 감소 확인
- "전체 삭제" 클릭 → 알림 모두 삭제

### 6. 중복 알림 방지 테스트
- 창 B에서 알림을 받은 후 다른 페이지로 이동
- 다시 알림 페이지로 돌아옴
- **같은 메시지에 대해 알림이 다시 생성되지 않아야 함**
- 브라우저 콘솔에서 "Notification already exists for message" 로그 확인

## ✨ 특징

### 장점
1. ✅ 브라우저 권한 필요 없음
2. ✅ 모든 브라우저에서 작동
3. ✅ **중복 알림 방지** (읽지 않은 알림만 체크)
4. ✅ 읽은 알림 자동 삭제로 깔끔한 관리
5. ✅ 알림 관리 기능 (클릭 시 삭제, X 버튼 삭제, 전체 삭제)
6. ✅ 클릭으로 페이지 이동
7. ✅ localStorage 저장으로 영구 보관 (읽지 않은 알림만)

### 브라우저 알림 대비 차이점
| 기능 | 웹 페이지 알림 | 브라우저 알림 |
|------|---------------|--------------|
| 권한 필요 | ❌ 불필요 | ✅ 필요 |
| 알림 이력 | ✅ 보관 | ❌ 일회성 |
| 알림 관리 | ✅ 가능 | ❌ 불가 |
| 다른 탭에서 | ⚠️ 벨 확인 필요 | ✅ 즉시 표시 |
| 모바일 지원 | ✅ 지원 | ⚠️ 제한적 |

## 🎨 커스터마이징

### 알림 아이콘 변경
```javascript
// NotificationBell.jsx
const getNotificationIcon = (type) => {
  switch (type) {
    case 'chat': return '💬'
    case 'meeting': return '📅'
    case 'system': return '🔔'
    default: return '📢'
  }
}
```

### 알림 스타일 변경
```jsx
// 읽지 않은 알림 배경색
className="bg-blue-50"  // 파란색

// 읽은 알림 배경색
className=""  // 흰색
```

### 알림 최대 개수 제한
```javascript
// notificationStore.js에 추가
const MAX_NOTIFICATIONS = 50

addNotification: (notification) => {
  set((state) => ({
    notifications: [
      newNotification,
      ...state.notifications
    ].slice(0, MAX_NOTIFICATIONS),  // 최대 50개만 유지
    unreadCount: state.unreadCount + 1,
  }))
}
```

## 🚀 향후 개선 가능 사항

1. **알림 사운드**
   - 새 알림 도착 시 소리 재생

2. **알림 그룹화**
   - 같은 모임의 메시지를 하나로 묶기

3. **알림 설정**
   - 사용자가 알림 종류 선택

4. **데스크톱 알림 병행**
   - 웹 알림 + 브라우저 알림 동시 지원

5. **읽은 알림 보기**
   - 옵션으로 읽은 알림도 확인 가능

6. **알림 히스토리**
   - 일정 기간 이후 자동 삭제 (예: 30일)

## 🐛 문제 해결

### 알림이 안 오는 경우
1. Realtime 구독 상태 확인
2. 콘솔에서 에러 확인
3. 브라우저 새로고침

### 중복 알림이 계속 생성되는 경우
1. **브라우저 콘솔 확인**: "Notification already exists for message: xxx" 로그가 나오는지 확인
2. **localStorage 확인**: 개발자 도구 → Application → Local Storage → notification-storage 확인
3. **임시 해결**: `localStorage.removeItem('notification-storage')` 실행 후 새로고침
4. **완전 초기화**: `localStorage.clear()` 실행 후 새로고침

### 읽은 알림이 계속 보이는 경우
1. 브라우저 콘솔에서 상태 확인: `useNotificationStore.getState().notifications`
2. 읽음 처리가 안 되었을 가능성 - 알림을 다시 클릭
3. localStorage 데이터 확인

### 알림 클릭이 안 되는 경우
1. 브라우저 캐시 삭제
2. 개발자 도구에서 에러 확인
3. 페이지 새로고침

## 📊 데이터 구조

### 알림 객체
```javascript
{
  id: 1634567890123.456,        // 타임스탬프 + 랜덤 (알림 고유 ID)
  type: 'chat',                  // 'chat' | 'meeting' | 'system'
  title: '새 채팅 메시지',        // 알림 제목
  message: '참가자2: 안녕하세요!', // 알림 내용
  meetingId: 'uuid...',          // 관련 모임 ID (옵션)
  messageId: 'msg-uuid...',      // 원본 메시지 ID (중복 방지용, 필수)
  timestamp: '2024-10-16T...',   // ISO 8601 형식
  read: false,                   // 읽음 여부
}
```

**중요 필드:**
- `id`: 알림 자체의 고유 ID (삭제용)
- `messageId`: 원본 메시지의 ID (중복 알림 방지용)
  - 같은 `messageId`를 가진 **읽지 않은 알림**이 있으면 생성되지 않음
  - 읽은 알림은 삭제되므로 같은 메시지도 나중에 다시 알림 생성 가능

---

**버전:** 2.3.0
**최종 업데이트:** 2025년 10월 25일

## 📝 변경 이력

### v2.3.0 (2025-10-25)
- ✅ 알림 클릭 시 완전 삭제로 변경 (markAsRead 대신 deleteNotification 사용)
- ✅ 중복 체크 로직 개선: 읽지 않은 알림만 체크하도록 수정
- ✅ localStorage 용량 최적화: 읽은 알림은 저장하지 않음
- ✅ 깔끔한 알림 관리: 읽은 알림이 계속 쌓이지 않음

### v2.2.0 (2025-01-25)
- ✅ messageId 기반 중복 알림 방지 시스템 구현
- ✅ 읽은 알림 자동 숨김 처리
- ✅ "모두 읽음" 버튼 제거 (읽으면 자동으로 사라지므로 불필요)
- ✅ 알림 클릭 시 즉시 목록에서 제거
- ✅ localStorage에 읽은 알림 유지로 중복 방지 강화

### v2.1.0 (2025-01-22)
- 웹 기반 알림 시스템 최초 구현
- Realtime 구독 및 폴링 기반 알림 생성

**개발 서버 실행:**
```bash
npm run dev
```
