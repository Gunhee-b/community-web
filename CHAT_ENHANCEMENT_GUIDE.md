# 채팅 기능 향상 가이드

## 개요

이 가이드는 모임 채팅 기능을 카카오톡 스타일로 향상시킨 내용을 설명합니다.

## 새로 추가된 기능

### 1. ✅ 이미지 전송 기능
- 채팅방에서 사진을 공유할 수 있습니다
- 이미지 클릭 시 새 탭에서 원본 이미지를 볼 수 있습니다
- 전송 전 미리보기 가능

### 2. ✅ 자동 스크롤
- 새 메시지가 도착하면 자동으로 최신 메시지로 스크롤됩니다

### 3. ✅ 입력 중 표시 (Typing Indicator)
- 다른 사용자가 메시지를 입력하고 있을 때 "OOO님이 입력 중..." 표시
- 애니메이션이 있는 점 3개로 시각적 효과 제공

### 4. ✅ 읽음 표시 (Read Receipts)
- 자신이 보낸 메시지 옆에 읽지 않은 사람 수 표시 (예: "2")
- 모든 사람이 읽으면 숫자가 사라집니다

### 5. ✅ 날짜 구분선
- 날짜별로 메시지를 그룹화하여 보여줍니다
- 날짜가 바뀌면 중앙에 날짜 배지가 표시됩니다

### 6. ✅ 카카오톡 스타일 UI
- 노란색 말풍선 (내 메시지)
- 하얀색 말풍선 (다른 사람 메시지)
- 둥근 모서리, 그림자 효과
- 시간 표시 (오전/오후 형식)
- 모임장은 👑 아이콘으로 표시

## 데이터베이스 마이그레이션 적용 방법

### 방법 1: Supabase Dashboard 사용 (권장)

1. Supabase 프로젝트 대시보드에 로그인
2. 왼쪽 메뉴에서 **SQL Editor** 선택
3. **New query** 클릭
4. `supabase/migrations/20250206_enhance_chat_features.sql` 파일의 내용을 복사하여 붙여넣기
5. **Run** 버튼 클릭하여 실행

### 방법 2: Supabase CLI 사용

```bash
# Supabase CLI가 설치되어 있어야 합니다
npx supabase db push

# 또는 특정 마이그레이션만 적용
npx supabase db push --include-all
```

### 마이그레이션이 추가하는 내용

1. **meeting_chats 테이블에 image_url 컬럼 추가**
   - 채팅 메시지에 이미지를 첨부할 수 있습니다

2. **meeting_typing_indicators 테이블 생성**
   - 입력 중 상태를 실시간으로 추적합니다
   - 10초 이상 입력이 없으면 자동으로 삭제됩니다

3. **meeting_chat_read_receipts 테이블 생성**
   - 각 메시지를 누가 읽었는지 추적합니다

4. **RLS (Row Level Security) 정책 추가**
   - 참가자만 해당 모임의 채팅 관련 데이터를 볼 수 있습니다

5. **Functions 추가**
   - `mark_meeting_chats_as_read`: 메시지를 읽음으로 표시
   - `cleanup_old_typing_indicators`: 오래된 입력 중 표시 자동 정리

6. **Realtime 활성화**
   - 새 테이블들에 대해 실시간 구독이 가능하도록 설정

## 테스트 방법

### 1. 기본 채팅 테스트
1. 두 개의 브라우저 (또는 시크릿 모드)로 각각 다른 사용자로 로그인
2. 같은 모임에 참가
3. 한 쪽에서 메시지 전송
4. 다른 쪽에서 실시간으로 메시지가 나타나는지 확인

### 2. 이미지 전송 테스트
1. 채팅 입력창 왼쪽의 이미지 아이콘 클릭
2. 이미지 파일 선택
3. 미리보기 확인 후 전송
4. 이미지가 채팅에 나타나는지 확인

### 3. 입력 중 표시 테스트
1. 한 쪽에서 메시지 입력 시작 (전송하지 않음)
2. 다른 쪽 화면 아래에 "OOO님이 입력 중..." 표시 확인
3. 입력을 멈추면 3초 후 사라지는지 확인

### 4. 읽음 표시 테스트
1. 사용자 A가 메시지 전송
2. 메시지 옆에 읽지 않은 사람 수 표시 확인 (예: "1")
3. 사용자 B가 채팅방 열기
4. 1초 후 숫자가 사라지는지 확인

### 5. 날짜 구분선 테스트
1. 이전 날짜의 메시지가 있는 모임 확인
2. 날짜별로 메시지가 그룹화되어 있는지 확인
3. 각 날짜 그룹 위에 날짜 배지가 표시되는지 확인

## UI 변경 사항

### 이전
- 단순한 메시지 리스트
- 파란색/흰색 말풍선
- 시간은 "3분 전" 형식
- 이미지 전송 불가
- 읽음 표시 없음

### 이후
- 카카오톡 스타일 UI
- 노란색(내 메시지)/흰색(타인 메시지) 말풍선
- 시간은 "오후 2:30" 형식
- 이미지 전송 가능
- 읽음 표시 (안 읽은 사람 수)
- 입력 중 표시
- 날짜 구분선
- 자동 스크롤

## 모바일 앱 적용

Capacitor를 통해 모바일 앱에서도 동일한 기능이 작동합니다:

1. **이미지 전송**: 모바일 카메라/갤러리에서 이미지 선택 가능
2. **입력 중 표시**: 실시간으로 동작
3. **읽음 표시**: 모바일에서도 확인 가능
4. **푸시 알림**: 새 메시지 도착 시 알림 (알림 시스템 구현 후)

## 주의사항

1. **데이터베이스 마이그레이션 필수**
   - 마이그레이션을 적용하지 않으면 채팅 기능이 작동하지 않습니다
   - 에러가 발생하면 Supabase 대시보드에서 로그 확인

2. **Storage 버킷 권한**
   - `meeting-images` 버킷이 이미 생성되어 있어야 합니다
   - `chat-images` 폴더에 대한 업로드 권한이 필요합니다

3. **Realtime 활성화**
   - Supabase 프로젝트에서 Realtime이 활성화되어 있어야 합니다
   - 새 테이블들이 Realtime publication에 추가되어야 합니다

4. **성능 고려사항**
   - 많은 메시지가 있는 채팅방의 경우 페이지네이션 고려 필요
   - 이미지는 적절한 크기로 압축하여 업로드 권장

## 문제 해결

### 이미지 업로드 실패
- Storage 버킷 권한 확인
- RLS 정책 확인
- 파일 크기 확인 (최대 5MB)

### 입력 중 표시가 안 나타남
- Realtime 구독 상태 확인
- 브라우저 콘솔에서 에러 확인
- 마이그레이션이 올바르게 적용되었는지 확인

### 읽음 표시가 업데이트 안 됨
- `mark_meeting_chats_as_read` 함수 실행 권한 확인
- RLS 정책 확인
- Realtime 구독 상태 확인

## 다음 단계

1. **푸시 알림 통합**
   - 새 메시지 도착 시 푸시 알림
   - 읽지 않은 메시지 개수 배지

2. **메시지 검색**
   - 채팅 내용 검색 기능

3. **이모지 반응**
   - 메시지에 이모지로 반응하기

4. **답장 기능**
   - 특정 메시지에 답장하기

5. **메시지 삭제**
   - 자신이 보낸 메시지 삭제하기

---

**작성일**: 2025년 2월 6일
**버전**: v2.7.0 (Chat Enhancement)
