-- ============================================================
-- 차단 기능 작동 테스트 (SQL Editor용)
-- ============================================================
-- SQL Editor에서는 auth.uid()를 사용할 수 없으므로
-- 실제 사용자 ID를 직접 조회해서 테스트합니다.
-- ============================================================

-- ============================================================
-- 1단계: auth.users에서 실제 사용자 ID 가져오기
-- ============================================================
SELECT
    id,
    email,
    raw_user_meta_data->>'username' as username,
    created_at
FROM auth.users
ORDER BY created_at DESC
LIMIT 10;

-- 위 결과에서 두 개의 다른 user ID를 복사하세요!
-- 예:
-- User 1 ID: 9fed83af-1c90-4100-a2ad-650e75e09dfb
-- User 2 ID: 12345678-1234-1234-1234-123456789012

-- ============================================================
-- 2단계: block_user 함수 직접 테스트
-- ============================================================
-- 아래의 UUID들을 위에서 복사한 실제 UUID로 교체하세요!

SELECT public.block_user(
    '9fed83af-1c90-4100-a2ad-650e75e09dfb'::uuid,  -- 첫 번째 사용자 ID (차단하는 사람)
    '12345678-1234-1234-1234-123456789012'::uuid,  -- 두 번째 사용자 ID (차단당하는 사람)
    'SQL Editor 테스트'                             -- 차단 이유
) as result;

-- 성공 시 결과: {"success": true}
-- 실패 시 결과: {"success": false, "error": "..."}

-- ============================================================
-- 3단계: user_blocks 테이블에서 확인
-- ============================================================
SELECT
    id,
    blocker_id,
    blocked_id,
    reason,
    created_at
FROM public.user_blocks
ORDER BY created_at DESC
LIMIT 5;

-- 위에서 추가한 차단 관계가 보이면 성공!

-- ============================================================
-- 4단계: unblock_user 함수 테스트
-- ============================================================
-- 위에서 사용한 동일한 UUID 사용

SELECT public.unblock_user(
    '9fed83af-1c90-4100-a2ad-650e75e09dfb'::uuid,  -- 첫 번째 사용자 ID (차단했던 사람)
    '12345678-1234-1234-1234-123456789012'::uuid   -- 두 번째 사용자 ID (차단 해제할 사람)
) as result;

-- ============================================================
-- 5단계: 차단이 해제되었는지 확인
-- ============================================================
SELECT COUNT(*) as remaining_blocks
FROM public.user_blocks;

-- 결과가 0이면 차단 해제 성공!

-- ============================================================
-- 6단계: get_blocked_user_ids 함수 테스트
-- ============================================================
SELECT public.get_blocked_user_ids(
    '9fed83af-1c90-4100-a2ad-650e75e09dfb'::uuid  -- 첫 번째 사용자 ID
) as blocked_users;

-- 차단한 사용자가 없으면 빈 배열 {} 반환
-- 차단한 사용자가 있으면 UUID 배열 반환

-- ============================================================
-- 참고: 앱에서는 어떻게 작동하나요?
-- ============================================================
-- 앱에서는 사용자가 로그인한 상태이므로:
-- - auth.uid()가 실제 사용자 ID를 반환합니다
-- - services/moderation.ts에서 자동으로 현재 사용자 ID를 사용합니다
-- - 사용자는 차단 버튼만 누르면 됩니다
--
-- SQL Editor 테스트는 데이터베이스 함수가 정상 작동하는지
-- 확인하기 위한 것입니다.
